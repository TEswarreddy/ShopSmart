@if (loading) {
	<p>Loading product...</p>
}

@if (!loading && error) {
	<div class="alert alert-danger" role="alert">{{ error }}</div>
	<a routerLink="/" class="btn btn-outline-dark btn-sm">Back to products</a>
}

@if (!loading && product) {
	<div class="row g-4 align-items-start mb-4">
		<div class="col-12 col-md-5">
			@if (product.image) {
				<img [src]="product.image" class="img-fluid detail-image" [alt]="product.title" />
			}
		</div>

		<div class="col-12 col-md-7">
			<p class="text-muted mb-1">{{ product.category || 'General' }}</p>
			<h1 class="h3">{{ product.title }}</h1>
			<p class="rating-summary">Average rating: ⭐ {{ product.rating || 0 | number: '1.1-1' }} / 5 ({{ product.numReviews || 0 }} reviews)</p>
			<p>{{ product.description }}</p>
			<p class="h5 mb-3">₹{{ product.price }}</p>
			<p class="stock" [class.out]="(product.stock || 0) <= 0">
				{{ (product.stock || 0) > 0 ? 'In stock' : 'Out of stock' }}
			</p>

			<div class="d-flex gap-2">
				<button type="button" class="btn btn-dark" (click)="addToCart()" [disabled]="(product.stock || 0) <= 0">Add to cart</button>
				<a routerLink="/" class="btn btn-outline-secondary">Back</a>
			</div>
		</div>
	</div>

	<section class="reviews-section">
		<h2 class="h5 mb-3">Product Reviews</h2>

		<div class="review-form card p-3 mb-3">
			<h3 class="h6 mb-2">Write a Review</h3>

			@if (!authService.isLoggedIn()) {
				<p class="text-muted mb-2">Please login to submit a rating and comment.</p>
			}

			@if (reviewError) {
				<div class="alert alert-danger py-2 mb-2" role="alert">{{ reviewError }}</div>
			}

			@if (reviewSuccess) {
				<div class="alert alert-success py-2 mb-2" role="alert">{{ reviewSuccess }}</div>
			}

			<div class="mb-2">
				<label class="form-label" for="rating">Rating (1-5)</label>
				<select id="rating" class="form-select" [(ngModel)]="reviewRating" [disabled]="!authService.isLoggedIn() || submittingReview">
					<option [ngValue]="1">1</option>
					<option [ngValue]="2">2</option>
					<option [ngValue]="3">3</option>
					<option [ngValue]="4">4</option>
					<option [ngValue]="5">5</option>
				</select>
			</div>

			<div class="mb-2">
				<label class="form-label" for="comment">Comment</label>
				<textarea
					id="comment"
					class="form-control"
					rows="3"
					placeholder="Share your experience"
					[(ngModel)]="reviewComment"
					[disabled]="!authService.isLoggedIn() || submittingReview"
				></textarea>
			</div>

			<button
				type="button"
				class="btn btn-dark btn-sm"
				(click)="submitReview()"
				[disabled]="!authService.isLoggedIn() || submittingReview"
			>
				{{ submittingReview ? 'Submitting...' : 'Submit Review' }}
			</button>
		</div>

		@if (!product.reviews || product.reviews.length === 0) {
			<p class="text-muted mb-0">No reviews yet.</p>
		}

		@if (product.reviews && product.reviews.length > 0) {
			<div class="review-list">
				@for (review of product.reviews; track review._id || review.name + review.comment) {
					<article class="review-card">
						<div class="review-head">
							<strong>{{ review.name }}</strong>
							<span>⭐ {{ review.rating }}</span>
						</div>
						<p class="mb-1">{{ review.comment }}</p>
						@if (review.createdAt) {
							<small class="text-muted">{{ review.createdAt | date: 'mediumDate' }}</small>
						}
					</article>
				}
			</div>
		}
	</section>
}
