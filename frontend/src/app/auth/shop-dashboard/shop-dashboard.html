<section class="shop-dashboard-shell">
  <div class="shop-dashboard-wrap">
    <button class="btn btn-outline-dark sidebar-toggle d-lg-none" type="button" (click)="toggleSidebar()">
      {{ sidebarOpen ? 'Close Menu' : 'Open Menu' }}
    </button>

    @if (sidebarOpen) {
      <button class="sidebar-backdrop d-lg-none" type="button" aria-label="Close sidebar" (click)="closeSidebar()"></button>
    }

    <aside class="dashboard-sidebar" [class.open]="sidebarOpen">
      <div class="sidebar-header">
        <h1 class="h5 mb-1">Shop Dashboard</h1>
        <small class="text-muted">Store Operations</small>
      </div>

      <nav class="sidebar-nav" aria-label="Shop menu">
        @for (item of sidebarItems; track item.id) {
          <button
            class="sidebar-link"
            type="button"
            [class.active]="isSectionActive(item.id)"
            (click)="selectSection(item.id)"
          >
            {{ item.label }}
          </button>
        }
      </nav>
    </aside>

    <div class="shop-dashboard-card">
      <h2 class="mb-1">{{ activeSectionLabel }}</h2>
      <p class="text-muted mb-3">Manage your shop from one place.</p>

      @if (!authService.isShopApproved()) {
        <div class="alert alert-warning" role="alert">
          Your shop account is pending admin approval. Dashboard operations are disabled until approval.
        </div>
      } @else {
        @if (error) {
          <div class="alert alert-danger" role="alert">{{ error }}</div>
        }

        @if (loading) {
          <p class="mb-0">Loading shop dashboard...</p>
        } @else {
          @if (activeSection === 'add-product') {
            <section class="dashboard-section">
              <h3 class="h5">Add Product</h3>
              <div class="grid two-col">
                <input class="form-control" placeholder="Title" [(ngModel)]="productForm.title" />
                <input class="form-control" type="number" min="0" placeholder="Price" [(ngModel)]="productForm.price" />
                <input class="form-control" placeholder="Category" [(ngModel)]="productForm.category" />
                <input class="form-control" type="number" min="0" placeholder="Stock" [(ngModel)]="productForm.stock" />
                <div class="full-width">
                  <label class="form-label mb-1">Upload Image</label>
                  <input class="form-control" type="file" accept="image/*" (change)="onAddProductImageSelected($event)" [disabled]="uploadingAddImage" />
                  <small class="text-muted">{{ uploadingAddImage ? 'Uploading image...' : 'PNG/JPG/WebP up to 5MB' }}</small>
                  @if (productForm.image) {
                    <img [src]="productForm.image" alt="Product preview" class="upload-preview mt-2" />
                  }
                </div>
                <textarea class="form-control full-width" rows="3" placeholder="Description" [(ngModel)]="productForm.description"></textarea>
              </div>
              <button class="btn btn-warning mt-2" type="button" [disabled]="savingProduct" (click)="addProduct()">
                {{ savingProduct ? 'Saving...' : 'Add Product' }}
              </button>
            </section>
          }

          @if (activeSection === 'manage-products') {
            <section class="dashboard-section">
              <h3 class="h5">Manage Products</h3>
              @if (products.length === 0) {
                <p class="text-muted mb-0">No products yet.</p>
              } @else {
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead>
                      <tr>
                        <th>Title</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (product of products; track product._id) {
                        <tr>
                          <td>{{ product.title }}</td>
                          <td>{{ product.price | currency: 'INR' : 'symbol' : '1.0-0' }}</td>
                          <td>{{ product.stock || 0 }}</td>
                          <td class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-dark" type="button" (click)="editProduct(product)">Edit</button>
                            <button class="btn btn-sm btn-outline-danger" type="button" [disabled]="deletingProductId === product._id" (click)="deleteProduct(product._id)">
                              {{ deletingProductId === product._id ? 'Deleting...' : 'Delete' }}
                            </button>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }

              @if (selectedProduct) {
                <div class="edit-card mt-2">
                  <h4 class="h6">Edit Product</h4>
                  <div class="grid two-col">
                    <input class="form-control" placeholder="Title" [(ngModel)]="selectedProduct.title" />
                    <input class="form-control" type="number" min="0" placeholder="Price" [(ngModel)]="selectedProduct.price" />
                    <input class="form-control" placeholder="Category" [(ngModel)]="selectedProduct.category" />
                    <input class="form-control" type="number" min="0" placeholder="Stock" [(ngModel)]="selectedProduct.stock" />
                    <div class="full-width">
                      <label class="form-label mb-1">Upload Image</label>
                      <input class="form-control" type="file" accept="image/*" (change)="onEditProductImageSelected($event)" [disabled]="uploadingEditImage" />
                      <small class="text-muted">{{ uploadingEditImage ? 'Uploading image...' : 'PNG/JPG/WebP up to 5MB' }}</small>
                      @if (selectedProduct.image) {
                        <img [src]="selectedProduct.image" alt="Edit preview" class="upload-preview mt-2" />
                      }
                    </div>
                    <textarea class="form-control full-width" rows="3" placeholder="Description" [(ngModel)]="selectedProduct.description"></textarea>
                  </div>
                  <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-warning" type="button" [disabled]="savingProduct" (click)="updateProduct()">Update Product</button>
                    <button class="btn btn-outline-dark" type="button" [disabled]="savingProduct" (click)="selectedProduct = null">Cancel</button>
                  </div>
                </div>
              }
            </section>
          }

          @if (activeSection === 'view-orders') {
            <section class="dashboard-section">
              <h3 class="h5">View Orders</h3>
              @if (shopOrders.length === 0) {
                <p class="text-muted mb-0">No orders for your shop yet.</p>
              } @else {
                <div class="order-list">
                  @for (order of shopOrders; track order._id) {
                    <article class="order-card">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Order #{{ order._id.slice(-6) }}</strong>
                        <small class="text-muted">{{ order.createdAt | date: 'mediumDate' }}</small>
                      </div>
                      <div class="small mb-1">Your Total: {{ (order.shopTotalPrice ?? order.totalPrice) | currency: 'INR' : 'symbol' : '1.0-0' }}</div>
                      <div class="small text-muted">Order Status: {{ order.orderStatus }} • Payment: {{ order.paymentStatus }}</div>
                      <ul class="item-list mt-2">
                        @for (item of order.items; track item.product._id) {
                          <li>{{ item.product.title }} × {{ item.quantity }}</li>
                        }
                      </ul>
                    </article>
                  }
                </div>
              }
            </section>
          }

          @if (activeSection === 'update-order-status') {
            <section class="dashboard-section">
              <h3 class="h5">Update Order Status</h3>
              @if (shopOrders.length === 0) {
                <p class="text-muted mb-0">No orders for your shop yet.</p>
              } @else {
                <div class="order-list">
                  @for (order of shopOrders; track order._id) {
                    <article class="order-card">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Order #{{ order._id.slice(-6) }}</strong>
                        <small class="text-muted">{{ order.createdAt | date: 'mediumDate' }}</small>
                      </div>
                      <div class="small mb-2">Your Total: {{ (order.shopTotalPrice ?? order.totalPrice) | currency: 'INR' : 'symbol' : '1.0-0' }}</div>
                      <div class="small text-muted mb-2">Current Status: {{ order.orderStatus }}</div>

                      <ul class="item-list mb-2">
                        @for (item of order.items; track item.product._id) {
                          <li>{{ item.product.title }} × {{ item.quantity }}</li>
                        }
                      </ul>

                      <div class="d-flex gap-2 flex-wrap">
                        @if (canUpdateOrderStatus(order)) {
                          <button class="btn btn-sm btn-outline-dark" type="button" (click)="updateOrderStatus(order, getNextStatus(order))">
                            Mark as {{ getNextStatus(order) }}
                          </button>
                        } @else {
                          <span class="text-muted small">No further status update allowed.</span>
                        }
                      </div>
                    </article>
                  }
                </div>
              }
            </section>
          }

          @if (activeSection === 'sales-report') {
            <section class="dashboard-section">
              <h3 class="h5">Sales Report</h3>
              @if (salesReport) {
                <div class="grid three-col mb-3">
                  <div class="metric-card">
                    <span>Total Sales</span>
                    <strong>{{ salesReport.totalSales | currency: 'INR' : 'symbol' : '1.0-0' }}</strong>
                  </div>
                  <div class="metric-card">
                    <span>Total Orders</span>
                    <strong>{{ salesReport.totalOrders }}</strong>
                  </div>
                  <div class="metric-card">
                    <span>Items Sold</span>
                    <strong>{{ salesReport.totalItemsSold }}</strong>
                  </div>
                </div>

                <h4 class="h6">Recent Orders</h4>
                @if (salesReport.recentOrders.length === 0) {
                  <p class="text-muted mb-0">No recent orders.</p>
                } @else {
                  <ul class="list-group list-group-flush">
                    @for (order of salesReport.recentOrders; track order._id) {
                      <li class="list-group-item px-0 d-flex justify-content-between">
                        <span>#{{ order._id.slice(-6) }} • {{ order.orderStatus }}</span>
                        <strong>{{ (order.shopTotalPrice ?? order.totalPrice) | currency: 'INR' : 'symbol' : '1.0-0' }}</strong>
                      </li>
                    }
                  </ul>
                }
              }
            </section>
          }
        }
      }
    </div>
  </div>
</section>
