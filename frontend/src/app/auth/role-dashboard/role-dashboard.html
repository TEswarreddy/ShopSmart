<section class="dashboard-shell">
  <div class="dashboard-card">
    <p class="welcome">Welcome, {{ authService.user()?.name }}</p>
    <h1>{{ heading() }}</h1>
    <p class="desc">{{ description() }}</p>

    <div class="meta-grid">
      <div>
        <span class="meta-label">Role</span>
        <strong>{{ authService.role() | titlecase }}</strong>
      </div>
      <div>
        <span class="meta-label">Email</span>
        <strong>{{ authService.user()?.email }}</strong>
      </div>
    </div>

    <div class="actions">
      <a class="btn btn-warning" [routerLink]="primaryRoute()">{{ primaryLabel() }}</a>
      @if (authService.role() === 'user') {
        <a class="btn btn-outline-dark" routerLink="/cart">Open Cart</a>
      }
    </div>

    @if (authService.role() === 'admin') {
      <section class="mt-4">
        <h2 class="h5">Shop Management</h2>

        @if (approvalError) {
          <div class="alert alert-danger" role="alert">{{ approvalError }}</div>
        }

        @if (approvalLoading) {
          <p class="mb-0">Loading shops...</p>
        } @else {
          @if (shops.length === 0) {
            <p class="text-muted mb-0">No shops found.</p>
          } @else {
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Shop</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Products</th>
                    <th>Orders</th>
                    <th>Sales</th>
                    <th>Owner</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (shop of shops; track shop._id) {
                    <tr>
                      <td>{{ shop.shopDetails?.shopName || shop.name }}</td>
                      <td>{{ shop.email }}</td>
                      <td>{{ shop.shopApprovalStatus | titlecase }}</td>
                      <td>{{ shop.totalProducts }}</td>
                      <td>{{ shop.totalOrders }}</td>
                      <td>₹{{ shop.totalSales }}</td>
                      <td>{{ shop.shopDetails?.ownerName || '-' }}</td>
                      <td class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-sm btn-success" type="button" [disabled]="shop.shopApprovalStatus === 'approved'" (click)="updateShopStatus(shop._id, 'approved')">Approve</button>
                        <button class="btn btn-sm btn-warning" type="button" [disabled]="shop.shopApprovalStatus === 'suspended'" (click)="updateShopStatus(shop._id, 'suspended')">Suspend</button>
                        <button class="btn btn-sm btn-outline-secondary" type="button" [disabled]="shop.shopApprovalStatus === 'rejected'" (click)="updateShopStatus(shop._id, 'rejected')">Reject</button>
                        <button class="btn btn-sm btn-outline-danger" type="button" (click)="deleteShop(shop._id)">Delete</button>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        }
      </section>

      <section class="mt-4">
        <h2 class="h5">User Management</h2>

        @if (users.length === 0) {
          <p class="text-muted mb-0">No users found.</p>
        } @else {
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Joined</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (user of users; track user._id) {
                  <tr>
                    <td>{{ user.name }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.phone || '-' }}</td>
                    <td>{{ user.isBlocked ? 'Blocked' : 'Active' }}</td>
                    <td>{{ user.createdAt | date: 'mediumDate' }}</td>
                    <td class="d-flex gap-2 flex-wrap">
                      <button class="btn btn-sm" [class.btn-warning]="!user.isBlocked" [class.btn-success]="user.isBlocked" type="button" (click)="toggleUserBlock(user)">
                        {{ user.isBlocked ? 'Unblock' : 'Block' }}
                      </button>
                      <button class="btn btn-sm btn-outline-danger" type="button" (click)="deleteUser(user._id)">Delete</button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </section>

      <section class="mt-4">
        <h2 class="h5">Product Monitoring</h2>

        @if (productError) {
          <div class="alert alert-danger" role="alert">{{ productError }}</div>
        }

        @if (productLoading) {
          <p class="mb-0">Loading products...</p>
        } @else {
          @if (products.length === 0) {
            <p class="text-muted mb-0">No products found.</p>
          } @else {
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Rating</th>
                    <th>Shop</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (product of products; track product._id) {
                    <tr>
                      <td>{{ product.title }}</td>
                      <td>{{ product.category || '-' }}</td>
                      <td>₹{{ product.price }}</td>
                      <td>{{ product.stock ?? 0 }}</td>
                      <td>{{ product.rating || 0 }} ({{ product.numReviews || 0 }})</td>
                      <td>{{ product.shop?.name || '-' }}</td>
                      <td>{{ product.createdAt ? (product.createdAt | date: 'mediumDate') : '-' }}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-danger" type="button" (click)="removeInappropriateProduct(product._id)">
                          Remove Inappropriate
                        </button>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        }
      </section>
    }
  </div>
</section>
